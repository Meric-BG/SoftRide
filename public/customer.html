<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Customer - FOTA POC</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/main.css">
</head>
<body>
  <h1>Customer - Available Updates</h1>
  <div id="updates"></div>

  <h2>Download Features On Demand</h2>
  <p>Enter features you need (comma separated):</p>
  <input id="featuresInput" placeholder="featureA,featureB">
  <button id="downloadFeatures">Download Bundle</button>

  <script>
  async function load() {
    const res = await fetch('/api/updates');
    const list = await res.json();
    const container = document.getElementById('updates');
    container.innerHTML = '';
    list.forEach(u => {
      const div = document.createElement('div');
      div.className = 'update';
      div.innerHTML = `<strong>${u.originalName}</strong> — ${u.version} — ${u.type} — features: ${u.features.join(', ')} <a href="/api/updates/${u.id}/download">Download</a>`;
      container.appendChild(div);
    });
  }
  document.getElementById('downloadFeatures').addEventListener('click', async () => {
    const raw = document.getElementById('featuresInput').value;
    const features = raw.split(',').map(s => s.trim()).filter(Boolean);
    if (features.length === 0) return alert('enter features');
    const res = await fetch('/api/feature-download', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ features })
    });
    if (!res.ok) {
      const err = await res.json().catch(()=>({error:'unknown'}));
      return alert('error: '+(err.error||res.status));
    }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'features_bundle.zip';
    a.click();
    URL.revokeObjectURL(url);
  });
  load();
  </script>
</body>
</html>
