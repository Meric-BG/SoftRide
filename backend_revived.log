[dotenv@17.2.3] injecting env (10) from backend/src/.env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
PRAGMA foreign_keys = ON
-- Kemet SDV - SQLite Schema Init

-- 1. USERS
CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER PRIMARY KEY AUTOINCREMENT,
    first_name TEXT,
    last_name TEXT,
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    phone_number TEXT,
    account_status TEXT DEFAULT 'ACTIVE',
    verified_email BOOLEAN DEFAULT 0,
    role TEXT DEFAULT 'user',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
-- 2. VEHICLES
CREATE TABLE IF NOT EXISTS vehicles (
    vin TEXT PRIMARY KEY,
    owner_id INTEGER REFERENCES users(user_id) ON DELETE CASCADE,
    brand_name TEXT,
    model_name TEXT,
    battery_level INTEGER DEFAULT 100,
    range_km INTEGER DEFAULT 400,
    os_version TEXT DEFAULT '1.0.0',
    is_locked BOOLEAN DEFAULT 1,
    is_charging BOOLEAN DEFAULT 0,
    climate_state BOOLEAN DEFAULT 0,
    location_name TEXT DEFAULT 'Dakar',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_seen DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_vehicles_owner ON vehicles(owner_id);
-- 3. FEATURES (Catalog)
CREATE TABLE IF NOT EXISTS features (
    feature_id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    price_amount DECIMAL(10, 2) NOT NULL,
    currency TEXT DEFAULT 'FCFA',
    payment_type TEXT, -- 'one-time', 'subscription'
    billing_interval TEXT, -- 'monthly', null
    is_active BOOLEAN DEFAULT 1,
    is_visible BOOLEAN DEFAULT 1,
    image_url TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
-- 4. SUBSCRIPTIONS (Purchases)
CREATE TABLE IF NOT EXISTS subscriptions (
    subscription_id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER REFERENCES users(user_id) ON DELETE CASCADE,
    vehicle_vin TEXT REFERENCES vehicles(vin) ON DELETE CASCADE,
    feature_id TEXT REFERENCES features(feature_id),
    status TEXT DEFAULT 'active',
    start_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    expires_at DATETIME,
    auto_renew BOOLEAN DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_subscriptions_user ON subscriptions(user_id);
CREATE INDEX IF NOT EXISTS idx_subscriptions_vehicle ON subscriptions(vehicle_vin);
CREATE INDEX IF NOT EXISTS idx_subscriptions_status ON subscriptions(status);
-- 5. FEATURE ACTIVATIONS
CREATE TABLE IF NOT EXISTS feature_activations (
    activation_id TEXT PRIMARY KEY,
    subscription_id INTEGER REFERENCES subscriptions(subscription_id) ON DELETE CASCADE,
    vehicle_vin TEXT REFERENCES vehicles(vin) ON DELETE CASCADE,
    feature_id TEXT REFERENCES features(feature_id),
    activation_status TEXT DEFAULT 'ACTIVE',
    target_status TEXT DEFAULT 'ACTIVE',
    activation_request_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    activation_start_time DATETIME,
    activation_end_time DATETIME,
    requested_by INTEGER REFERENCES users(user_id),
    request_source TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_activations_vehicle ON feature_activations(vehicle_vin);
CREATE INDEX IF NOT EXISTS idx_activations_subscription ON feature_activations(subscription_id);
-- 6. PAYMENTS (For tracking payment transactions)
CREATE TABLE IF NOT EXISTS payments (
    payment_id TEXT PRIMARY KEY,
    user_id INTEGER REFERENCES users(user_id) ON DELETE CASCADE,
    feature_id TEXT REFERENCES features(feature_id),
    subscription_id INTEGER REFERENCES subscriptions(subscription_id),
    operator TEXT, -- 'ORANGE', 'WAVE', etc.
    phone_number TEXT,
    amount DECIMAL(10, 2) NOT NULL,
    currency TEXT DEFAULT 'FCFA',
    status TEXT DEFAULT 'PENDING', -- 'PENDING', 'PAID', 'FAILED'
    transaction_ref TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_payments_user ON payments(user_id);
CREATE INDEX IF NOT EXISTS idx_payments_status ON payments(status);
-- 7. ANALYTICS VIEWS
DROP VIEW IF EXISTS revenue_analytics_view;
CREATE VIEW revenue_analytics_view AS
    SELECT f.feature_id, f.name, f.price_amount, 
           COUNT(s.subscription_id) as active_subscriptions, 
           (f.price_amount * COUNT(s.subscription_id)) as total_revenue
    FROM features f
    LEFT JOIN subscriptions s ON f.feature_id = s.feature_id AND s.status = 'active'
    GROUP BY f.feature_id, f.name, f.price_amount;
DROP VIEW IF EXISTS vehicle_status_view;
CREATE VIEW vehicle_status_view AS
    SELECT vin, model_name, 
           CASE WHEN last_seen > datetime('now', '-1 hour') THEN 'connected' ELSE 'offline' END as connectivity_status
    FROM vehicles;
-- 8. SEED DATA
-- Default Admin: admin@kemet.com / admin123
INSERT OR IGNORE INTO users (email, password_hash, first_name, last_name, account_status, role) VALUES 
('admin@kemet.com', '$2b$10$gkQWPsEU8cYWUxdtuyC9PedDwWQEK9gR4c9MQHNxXz496bMD23k6.', 'Admin', 'Kemet', 'ACTIVE', 'admin');
-- Default Features
INSERT OR IGNORE INTO features (feature_id, name, description, price_amount, payment_type, billing_interval) VALUES 
('premium-connect', 'ConnectivitÃ© Premium', 'AccÃ¨s streaming, cartes satellite et navigation en temps rÃ©el', 2500, 'subscription', 'monthly'),
('acceleration-boost', 'Acceleration Boost', 'RÃ©duction du 0-100 km/h de 4.4s Ã  3.9s', 1500000, 'one-time', NULL),
('sentry-mode', 'Mode Sentinelle', 'SÃ©curitÃ© active avec enregistrement vidÃ©o 360Â°', 5000, 'subscription', 'monthly'),
('cold-weather-pack', 'Pack Hiver', 'SiÃ¨ges et volant chauffants toutes places', 250000, 'one-time', NULL);
-- 9. FOTA TABLES
CREATE TABLE IF NOT EXISTS fota_campaigns (
    campaign_id TEXT PRIMARY KEY,
    campaign_name TEXT NOT NULL,
    version TEXT NOT NULL,
    description TEXT,
    release_notes TEXT,
    campaign_type TEXT DEFAULT 'SCHEDULED',
    priority INTEGER DEFAULT 3,
    rollout_strategy TEXT DEFAULT 'PHASED',
    scheduled_start DATETIME,
    status TEXT DEFAULT 'available',
    size_mb INTEGER,
    is_critical BOOLEAN DEFAULT 0,
    created_by INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE IF NOT EXISTS vehicle_updates (
    update_id INTEGER PRIMARY KEY AUTOINCREMENT,
    vehicle_vin TEXT REFERENCES vehicles(vin) ON DELETE CASCADE,
    campaign_id TEXT REFERENCES fota_campaigns(campaign_id),
    status TEXT DEFAULT 'available', -- 'available', 'downloading', 'installing', 'completed', 'failed'
    progress INTEGER DEFAULT 0,
    installed_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
-- Seed FOTA
INSERT OR IGNORE INTO fota_campaigns (campaign_id, campaign_name, version, description, release_notes, size_mb, is_critical, status) VALUES 
('v1.1.0-release', 'Version 1.1.0', '1.1.0', 'Mise Ã  jour de performance', 'AmÃ©lioration de la gestion batterie et nouvelles icÃ´nes.', 450, 0, 'COMPLETED');
-- Service & Support Requests
CREATE TABLE IF NOT EXISTS service_requests (
    request_id TEXT PRIMARY KEY,
    user_id INTEGER NOT NULL,
    type TEXT NOT NULL, -- 'SUPPORT', 'SERVICE', 'FEATURE', 'BUG'
    subject TEXT NOT NULL,
    description TEXT NOT NULL,
    status TEXT DEFAULT 'OPEN', -- 'OPEN', 'IN_PROGRESS', 'RESOLVED', 'CLOSED'
    priority TEXT DEFAULT 'MEDIUM', -- 'LOW', 'MEDIUM', 'HIGH', 'URGENT'
    admin_notes TEXT,
    ai_analysis TEXT, -- Stores AI proposed solutions for developers
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);
-- Seed some initial requests for demo
INSERT OR IGNORE INTO service_requests (request_id, user_id, type, subject, description, status, priority, ai_analysis)
VALUES 
('req1', 1, 'BUG', 'ProblÃ¨me de charge', 'Ma voiture ne dÃ©passe pas les 80% de charge sur les bornes rapides.', 'OPEN', 'HIGH', '{"solution": "VÃ©rifier les limites de charge logicielle et l''Ã©tat de santÃ© des cellules (SOH). Une mise Ã  jour du BMS pourrait Ãªtre nÃ©cessaire."}'),
('req2', 1, 'FEATURE', 'Mode Sommeil', 'Serait-il possible d''ajouter un mode pour dormir dans la voiture avec la clim ?', 'IN_PROGRESS', 'MEDIUM', '{"solution": "ImplÃ©menter une boucle de contrÃ´le thermique Ã  faible bruit et dÃ©sactiver les capteurs de mouvement internes pendant l''activation."}');
âœ… SQLite Database initialized successfully
ğŸ” JWT Secret initialized: kemet...
ğŸ¤– Kemet AI Service initialized | Provider: groq | Model: llama-3.3-70b-versatile | Key: gsk_7DztGB...

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                               â•‘
â•‘        ğŸš— KEMET API Server                    â•‘
â•‘                                               â•‘
â•‘        Port: 5000                             â•‘
â•‘        Environment: development              â•‘
â•‘                                               â•‘
â•‘        Endpoints disponibles:                 â•‘
â•‘        â€¢ POST /api/auth/login                 â•‘
â•‘        â€¢ POST /api/auth/register              â•‘
â•‘        â€¢ GET  /api/vehicles/:id               â•‘
â•‘        â€¢ GET  /api/store/features             â•‘
â•‘        â€¢ GET  /api/updates                    â•‘
â•‘        â€¢ GET  /api/analytics/overview         â•‘
â•‘                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
